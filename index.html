<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monika & Artur – Rejestr jaj (edycja)</title>
  <!-- Bootstrap CSS for a nowoczesny wygląd -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    integrity="sha384-9ndCyUa1zKpHu+FA1lYCFb/oG6s7nU30ncoigkNDJ9vqWwEQfFGRC3qmRRY7W+Jd"
    crossorigin="anonymous"
  />
  <!-- Ładowanie modułów Firebase z CDN (wersja 9) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getDatabase,
      ref,
      push,
      onValue,
      update,
      remove
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // Konfiguracja Firebase (Twoje dane z konsoli)
    const firebaseConfig = {
      apiKey: "AIzaSyAItihAw7npW0lxkoNysM49xzeOXpGAzdg",
      authDomain: "nasze-jaja-100.firebaseapp.com",
      databaseURL: "https://nasze-jaja-100-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nasze-jaja-100",
      storageBucket: "nasze-jaja-100.firebasestorage.app",
      messagingSenderId: "695477910328",
      appId: "1:695477910328:web:ceb854c3dc147084aa9fcd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elementy DOM
    const form = document.querySelector('#eggForm');
    const userSelect = document.querySelector('#user');
    const eggInput = document.querySelector('#eggs');
    const messageDiv = document.querySelector('#message');
    const tableBody = document.querySelector('#entriesBody');
    const totalsDiv = document.querySelector('#totals');

    // Mapa id→wpis (do edycji)
    let entriesById = {};

    // Funkcje pomocnicze
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatDate(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Zwraca nazwę dnia tygodnia w języku polskim dla podanej daty w formacie YYYY-MM-DD
    function getDayName(dateStr) {
      const days = ['Niedziela','Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota'];
      const date = new Date(dateStr);
      return days[date.getDay()];
    }

    async function saveEntry(user, eggs) {
      const now = new Date();
      const entry = {
        user: user,
        eggs: parseInt(eggs, 10),
        timestamp: now.toISOString(),
        date: formatDate(now)
      };
      await push(ref(db, 'entries'), entry);
    }

    function updateDisplay(entries) {
      tableBody.innerHTML = '';
      entriesById = {};
      const weeklyTotals = {};
      entries.forEach(entry => {
        entriesById[entry.id] = entry;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${getDayName(entry.date)}</td>
          <td>${entry.user}</td>
          <td>${entry.eggs}</td>
          <td>
            <button data-id="${entry.id}" data-eggs="${entry.eggs}" data-user="${entry.user}" class="edit-btn btn btn-outline-primary me-2">Edytuj</button>
            <button data-id="${entry.id}" class="delete-btn btn btn-outline-danger">Usuń</button>
          </td>`;
        tableBody.appendChild(row);
        // Sumowanie tygodniowe
        const weekStart = formatDate(getWeekStart(entry.date));
        if (!weeklyTotals[weekStart]) weeklyTotals[weekStart] = { Monika: 0, Artur: 0 };
        weeklyTotals[weekStart][entry.user] += entry.eggs;
      });
      // Podsumowanie bieżącego tygodnia
      const today = new Date();
      const currentWeek = formatDate(getWeekStart(today));
      const totals = weeklyTotals[currentWeek] || { Monika: 0, Artur: 0 };
      const totalMonika = totals['Monika'] || 0;
      const totalArtur = totals['Artur'] || 0;

      // Oblicz sumę jaj dzisiaj (łącznie) i w tym tygodniu (łącznie)
      let todayTotal = 0;
      const todayStr = formatDate(today);
      entries.forEach(ent => {
        if (ent.date === todayStr) {
          todayTotal += ent.eggs;
        }
      });
      const weekTotal = totalMonika + totalArtur;
      let summaryHTML = `<p>Podsumowanie tygodniowe (${currentWeek} – ${formatDate(new Date(today.getFullYear(), today.getMonth(), today.getDate() + (7 - today.getDay())))}):</p>`;
      summaryHTML += `<p>Monika zebrała <strong>${totalMonika}</strong> jaj.</p>`;
      summaryHTML += `<p>Artur zebrał <strong>${totalArtur}</strong> jaj.</p>`;
      // Dodatkowe informacje: dzisiaj i cały tydzień (łączna liczba jaj)
      summaryHTML += `<p>Dzisiaj: <strong>${todayTotal}</strong> jaj.</p>`;
      summaryHTML += `<p>W tym tygodniu: <strong>${weekTotal}</strong> jaj.</p>`;
      const diff = totalMonika - totalArtur;
      if (today.getDay() === 0) {
        if (diff > 0) {
          summaryHTML += `<p><strong>Bilans:</strong> Monika ma oddać ${diff / 2} jaj Arturowi, aby oboje mieli po ${totalMonika - diff / 2} jaj.</p>`;
        } else if (diff < 0) {
          summaryHTML += `<p><strong>Bilans:</strong> Artur ma oddać ${Math.abs(diff) / 2} jaj Monice, aby oboje mieli po ${totalArtur - Math.abs(diff) / 2} jaj.</p>`;
        } else {
          summaryHTML += `<p><strong>Bilans:</strong> Jesteście na zero. Nie trzeba nic wyrównywać.</p>`;
        }
      } else {
        // Komunikat o bilansie w niedzielę – na czerwono
        summaryHTML += `<p class="text-danger">Bilans zostanie obliczony w niedzielę wieczorem.</p>`;
      }
      totalsDiv.innerHTML = summaryHTML;
    }

    // Nasłuchuj zmiany w bazie
    onValue(ref(db, 'entries'), snapshot => {
      const data = snapshot.val() || {};
      const entries = [];
      for (const key in data) {
        entries.push({ id: key, ...data[key] });
      }
      entries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      updateDisplay(entries);
    });

    // Obsługa wysyłania formularza
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const user = userSelect.value;
      const eggs = eggInput.value;
      if (!eggs) {
        messageDiv.textContent = 'Proszę podać liczbę jaj.';
        return;
      }
      await saveEntry(user, eggs);
      messageDiv.textContent = 'Wpis został zapisany!';
      eggInput.value = '';
    });

    // Delegacja zdarzeń dla przycisków edycji i usuwania
    tableBody.addEventListener('click', async e => {
      const target = e.target;
      const id = target.dataset.id;
      if (!id) return;
      if (target.classList.contains('delete-btn')) {
        const confirmDel = confirm('Czy na pewno chcesz usunąć ten wpis?');
        if (confirmDel) {
          await remove(ref(db, `entries/${id}`));
        }
      } else if (target.classList.contains('edit-btn')) {
        const entry = entriesById[id];
        if (!entry) return;
        const newEggsStr = prompt('Podaj nową liczbę jaj:', entry.eggs);
        if (newEggsStr === null) return;
        const newEggs = parseInt(newEggsStr, 10);
        if (isNaN(newEggs)) {
          alert('Wpisz poprawną liczbę');
          return;
        }
        await update(ref(db, `entries/${id}`), { eggs: newEggs });
      }
    });

    // Obsługa przycisku resetu – usuwa wszystkie wpisy z bazy
    const resetButton = document.querySelector('#resetButton');
    if (resetButton) {
      resetButton.addEventListener('click', async () => {
        const confirmReset = confirm('Czy na pewno chcesz usunąć wszystkie wpisy?');
        if (confirmReset) {
          await remove(ref(db, 'entries'));
        }
      });
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      color: #333;
      /* Jasne tło oraz delikatny motyw w tle */
      background-color: #fbfbfb;
      background-image:
        linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
        url('chicken_banner.png');
      background-repeat: repeat;
      background-size: 250px 250px;
    }
    /* Własne dopasowania do Bootstrapa */
    #message {
      margin-top: 5px;
    }
    #totals-card {
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Zwiększenie czytelności na telefonie */
    table.table {
      font-size: 1.1rem;
    }
    .table th, .table td {
      padding: 0.75rem;
    }

    /* Pasek nagłówka */
    #header-bar {
      /* Jasny gradient i ciemny tekst */
      background: linear-gradient(90deg, #e8f0fe 0%, #fdfcff 100%);
      color: #333;
      border-radius: 0.25rem;
    }

    /* większe etykiety dla lepszej czytelności */
    .big-label {
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* większe kontrolki formularza */
    .big-control {
      font-size: 1.3rem;
      padding: 1rem;
      height: auto;
    }

    /* bardzo duży przycisk zapisu */
    .btn-very-large {
      font-size: 1.2rem;
      padding: 0.75rem 1.5rem;
    }

    /* pogrubienie kolumny z liczbą jaj */
    .table td:nth-child(3) {
      font-weight: bold;
    }

    /* mała czcionka dla notatki na dole */
    .small-note {
      font-size: 0.75em;
    }
  </style>
</head>
<body class="container my-4">
  <!-- Pasek nagłówka z wyśrodkowanym tytułem -->
  <div id="header-bar" class="py-3 px-4 mb-4">
    <h1 class="text-center m-0">Monika &amp; Artur – biznes jajowy</h1>
  </div>
  <form id="eggForm" class="mb-4">
    <div class="mb-4">
      <label for="user" class="form-label big-label">Osoba:</label>
      <select id="user" class="form-select big-control" required>
        <option value="Monika">Monika</option>
        <option value="Artur">Artur</option>
      </select>
    </div>
    <div class="mb-5">
      <label for="eggs" class="form-label big-label">Liczba zebranych jaj:</label>
      <input type="number" id="eggs" class="form-control big-control" min="0" required />
    </div>
    <button type="submit" class="btn btn-primary btn-very-large">Zapisz</button>
    <div id="message" class="text-success mt-2"></div>
  </form>
  <h2>Wprowadzone wpisy</h2>
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Dzień</th>
        <th>Osoba</th>
        <th>Liczba jaj</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody id="entriesBody">
      <!-- Wiersze będą generowane dynamicznie -->
    </tbody>
  </table>
  <!-- Sekcja z podsumowaniem opakowana w kartę -->
  <div id="totals-card" class="card mb-3">
    <div class="card-body" id="totals"></div>
  </div>
  <!-- Przycisk do resetu danych -->
  <div class="mb-4">
    <button type="button" id="resetButton" class="btn btn-danger">Resetuj tydzień</button>
  </div>
  <p class="text-muted small-note">Możesz edytować lub usuwać wpisy klikając przyciski w kolumnie "Akcje". Zmiany są od razu zapisywane w bazie Firebase.</p>
</body>
</html>
